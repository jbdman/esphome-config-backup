!function(){"use strict";function n(o,n=document){return new Promise(function(t){var e=n.querySelector(o);if(e)return t(e);const r=new MutationObserver(function(){var e=n.querySelector(o);e&&(r.disconnect(),t(e))});r.observe(n,{childList:!0,subtree:!0})})}function y(e){var t=atob(e),r=t.length,o=new Uint8Array(r);for(let e=0;e<r;e++)o[e]=t.charCodeAt(e);return o}async function e(){var r,e=await n("esp-app"),e=(r=e,await new Promise(function(e){if(r.shadowRoot)return e(r.shadowRoot);const t=new MutationObserver(function(){r.shadowRoot&&(t.disconnect(),e(r.shadowRoot))});t.observe(r,{childList:!1,subtree:!1,attributes:!0})}));if(!e)return console.warn("No shadowRoot on <esp-app>");var t=(await n("main.flex-grid-half",e)).querySelectorAll("section.col")[0],o=(await n('form[action="/update"]',t),document.createElement("div"));o.innerHTML='<h2>Config Backup</h2><form id="config-backup-form"><input id="decrypt-key" placeholder="Key" />&nbsp;<input class="btn" type="submit" value="Decrypt" /></form><pre id="decrypt-output" style="white-space: pre-wrap; margin-top: 10px;"></pre>',t.appendChild(o),e.getElementById("config-backup-form").addEventListener("submit",async function(t){t.preventDefault();var t=t.target,r=t.querySelector("#decrypt-key").value;t.parentElement.querySelector("#decrypt-output").textContent="";try{var o=await fetch(CONF_PATH),n=o.headers.get("X-Encryption-Type"),a=o.headers.get("X-Compression-Type"),i=await o.text();let e="";if("gzip"===a)e=await async function(n,e,t){let r=n,o,a,i,c,s;return"aes256"===t?r=function(e){var t=CryptoJS.enc.Base64.parse(n);if(t.words.length<8)throw new Error("Invalid AES blob (must include salt and IV).");var r=CryptoJS.lib.WordArray.create(t.words.slice(0,4)),o=CryptoJS.lib.WordArray.create(t.words.slice(4,8)),t=CryptoJS.lib.WordArray.create(t.words.slice(8)),e=CryptoJS.PBKDF2(e,r,{keySize:8,iterations:1e5,hasher:CryptoJS.algo.SHA256}),r=CryptoJS.AES.decrypt({ciphertext:t},e,{iv:o,mode:CryptoJS.mode.CBC,padding:CryptoJS.pad.Pkcs7});return CryptoJS.enc.Base64.stringify(r)}(e):"xor"===t&&(r=function(e){var t=y(n),r=(new TextEncoder).encode(e),o=new Uint8Array(t.length);for(let e=0;e<t.length;e++)o[e]=t[e]^r[e%r.length];return btoa(o)}(e)),o=r,a=Uint8Array.from(atob(o),e=>e.charCodeAt(0)),i=new DecompressionStream("gzip"),(c=i.writable.getWriter()).write(a),c.close(),s=await new Response(i.readable).arrayBuffer(),(new TextDecoder).decode(s)}(i,r,n);else switch(n){case"aes256":e=function(e){var t=CryptoJS.enc.Base64.parse(i);if(t.words.length<8)throw new Error("Invalid AES blob (must include salt and IV).");var r=CryptoJS.lib.WordArray.create(t.words.slice(0,4)),o=CryptoJS.lib.WordArray.create(t.words.slice(4,8)),t=CryptoJS.lib.WordArray.create(t.words.slice(8)),e=CryptoJS.PBKDF2(e,r,{keySize:8,iterations:1e5,hasher:CryptoJS.algo.SHA256}),r=CryptoJS.AES.decrypt({ciphertext:t},e,{iv:o,mode:CryptoJS.mode.CBC,padding:CryptoJS.pad.Pkcs7});return CryptoJS.enc.Utf8.stringify(r)}(r);break;case"xor":e=function(e){var t=y(i),r=(new TextEncoder).encode(e),o=new Uint8Array(t.length);for(let e=0;e<t.length;e++)o[e]=t[e]^r[e%r.length];return(new TextDecoder).decode(o)}(r);break;default:e=atob(i)}if(!e)throw new Error("Decryption failed — possibly wrong key?");var{filename:c,fileData:s}=function(e){var t=e.indexOf("\n");if(-1!==t){var r=e.substring(0,t).trim();if(r.startsWith("# filename:"))return{filename:r.substring("# filename:".length).trim(),fileData:e.substring(t+1)}}return{filename:window.location.hostname+".yaml",fileData:e}}(e);{var d=c||(window.location.hostname||"download")+".yaml",l=new Blob([s],{type:"application/octet-stream"});const p=URL.createObjectURL(l),u=document.createElement("a");u.href=p,u.download=d,document.body.appendChild(u),u.click(),setTimeout(function(){document.body.removeChild(u),URL.revokeObjectURL(p)},0)}}catch(e){t.parentElement.querySelector("#decrypt-output").textContent="❌ Error: "+e.message,console.error(e)}})}"loading"===document.readyState?(console.log("Attaching listener..."),document.addEventListener("DOMContentLoaded",e)):e()}();